<?php
namespace Home\Controller;
use Org\Util\Des;
use Think\Controller;
use Think\Model;

class AppController extends CommonController {
    protected $model;

    public function _initialize(){
        parent::_initialize();
        $this->model=new Model();
    }
    public function addCustomInfo(){
        if(IS_POST){
            set_time_limit(0);
            if(empty( $_FILES['file_stu']['name'])){
                $this->error('请上传卡号文件',U('Card/addCustomInfo'));
            }
            $upload=$this->_upload('excel');
            if(is_string($upload)){
                $this->error($upload,U('Card/addCustomInfo'));
            }else{
                $filename=PUBLIC_PATH.$upload['file_stu']['savepath'].$upload['file_stu']['savename'];
                $exceldate=$this->import_excel($filename);

                $model=new model();
                $c=$c1=0;
                $str='';
                $where['cal.status']='Y';
                $where['cu.namechinese']=array('EXP','IS NULL');
                $where['cu.personid']=array('EXP','IS NULL');
                $where['cal.activedate']=array('egt','20150801');
                $where['c.brandid']='6889';
                $list=$model->table('card_active_logs')->alias('cal')
                    ->join('__CARDS__ c on cal.cardno=c.cardno')
                    ->join('__CUSTOMS_C__ cc on cc.cid=c.customid')
                    ->join('__CUSTOMS__ cu on cu.customid=cc.customid')
                    ->field('cal.cardno,cu.namechinese,cu.customid,cu.PersonID,cal.status')->where($where)
                    ->order('cal.activedate asc')->limit(0,1500)->select();
                foreach($exceldate as $key=>$val){
                    $data=array(
                        'namechinese'=>$val[0],
                        'linktel'=>$val[1],
                        'personid'=>$val[2],
                        'sex'=>$val[3],
                        'cityid'=>$val[4],
                        'birthday'=>substr($val[2],6,8)
                    );
                    $map['customid']=$list[$key]['customid'];
                    if(D('customs')->where($map)->save($data)){
                        //$str.='客户编号：'.$list['customid'].'，名字:'.$val[0].'<br/>';
                        $c++;
                    }else{
                        $c1++;
                    }
                }
                echo '执行成功'.$c.'条，失败'.$c1.'条执行的客户编号如下'.'<br/>';
                //echo $str;
                //$this->success('执行成功'.$c.'条，失败'.$c1.'条');
            }
        }else{
            $this->display();
        }
    }

    public function addCustomInfo1(){
        $customs = array();
        $model=new model();
        $c=$c1=0;
        $str='';
        $where['cal.status']='Y';
        $where['cu.namechinese']=array('EXP','IS NULL');
        $where['cu.personid']=array('EXP','IS NULL');
        $where['cal.activedate']=array('egt','20150801');
        $where['c.brandid']='6889';
        $list=$model->table('card_active_logs')->alias('cal')
            ->join('__CARDS__ c on cal.cardno=c.cardno')
            ->join('__CUSTOMS_C__ cc on cc.cid=c.customid')
            ->join('__CUSTOMS__ cu on cu.customid=cc.customid')
            ->field('cal.cardno,cu.namechinese,cu.customid,cu.PersonID,cal.status')->where($where)
            ->order('cal.activedate asc')->limit(0,1000)->select();
        foreach($customs as $key=>$val){
            $sexNum=substr($val['o_cardnum'],-2,1);
            $sex=$sexNum%2==0?'女':'男';
            $data=array(
                'namechinese'=>$val['o_name'],
                'linktel'=>$val['o_mobile'],
                'personid'=>$val['o_cardnum'],
                'sex'=>$sex,
                'cityid'=>'379',
                'birthday'=>substr($val['o_cardnum'],6,8)
            );
            $map['customid']=$list[$key]['customid'];
            if(D('customs')->where($map)->save($data)){
                //$str.='客户编号：'.$list[$key]['customid'].'，名字:'.$val['o_name'].'<br/>';
                //echo $str;
                $c++;
            }else{
                $c1++;
            }

        }
        echo '执行成功'.$c.'条，失败'.$c1.'条执行的客户编号如下'.'<br/>';
    }

    public function test0(){
        $startStr='1346011156170813460191346018134601713460161346015134601413462711346012
        1346272134601013409441563703156370215637011563700155186913460131346290134629913462981346297
        1346296134629513462941346293134627013462911561707134627913462781346277134627613462751346274
        13462731346292155370015617091553708155370715537061553705155370415537031553900155370115539011551876
        1551875155187415518731551872155187113781411553702155390915617061561705156170415617031561702156170115617001553709
        1553977135076915539081553907155390615539051553904155390315539021560370136037013503401363960136337013629871362370
        1361987136137013653701360840136637013598391359838135983713598361359835135983413598331360864137034213781401374969
        13749681374967137496613749651374964136437013703701359830137008313700701369370136837013673841367383136737013703971352380
        13569301352634135263313526321352631135263013523831359832135238113569331352370135231713523161352315135231413513701551868
        13523821359231135037013592391359238135923713592361359235135923413569311359232135693213592301356939135693813569371356936
        13569351356934135983113592331314801158247513148091314808131480713148061314805131480413183291314802131934013148001314057
        15824701582471158247215824731551870131480313233871327103132710213271011327100132432713243261324325131830413233881582476
        1323386132338513223901322370132230013193421319341132338915837051582474158368715836881583689158370015837011583702158368515837041583684158370615837071583708158370915839001583901158390315837031583646158247715824781582479158364015836411583642158364315836861583645132710615836471583648158364915836801583681158368215836831583644130375613271041310360131017013087021308370130437013037591310390130375713137001303755130375413037531303752130375113037501523852130375815517081551867155186615518651551864155186315518621551861131037015517091523855155170715517061551705155170413137031313702131370115518601327382155149415514931551492155149115514901551420132837015238531327383155149713273701327111132711013271091327108132710715839021327384152399413271051523856152385715238581523859152399015239911551495152399315514961580370155170315517021551701155170015514991551498152385415239921513858151370515224751520370151397415139731513972151397115224771513859152247815138571513856151385515137091513708151370713837051513970152252615993991523684152368315236821523681152368015225291522476152252715137041522525152252415225231522522152252115225201522479152252813849671513706139370413937031393702139370113937001390370139370613849681393707138496613849651384964138370913837081383707138370613849691394992151370315137021513701151370015136641503665150037013937051394993152368813949911394990139389413938931393892139370913937081394994159383115236861593839159383815938371593836159383515938341593906159383215939071593830159370915937081593707159370615937051593704159383315993901583904159939815993971599396159939515993941599393159390515993911593701159934415993431599342159934115993401593909159390815993921523705158390715839061583905152385115238501523709152370815937031523706158969015237041523703152370215237011523700152368915236851523707158969813781421593700159038415903831590382159038115903801583908158969915839091589697158969615896951589694158969315896921589691159370215903701509063156499015136001510370150906915090681509067150906615136021509064151360315090621509061150906015090591509058150905715090551509065151366115638631563709156370815637071563706156370515637041513601151366215090511513660151360915136081513607151360615136051513604151366313781481503701150370015036691503668150366715036661378151150905313781491503704137814713781461378145137814413837041523687137814313781501508292150905615090501508299150829815082971508296150829515037021508293150370315082911508290150370915037081503707150370615037051509052150829413409411893703137815713781561378155137815413781531378152137815913409421378160134094013403701893709189370818937071893706189370518937041340943137816913837031509054138370215649911383700138039713803701378158137837013837011378168137816713781661378165137816413781631378162137816113800371863903133466013343701334360133337013323701332360133037013346611863904156499418603701569077156907615664011566400156499318937021863905153438415649921893700189037013346621534385189370115343701533370153038015303701338370133537013353621335361153039715343861335360155381615538221553821155382015538191553817155381815538231553824155382515538261553827156177515538151561777155380515617781561776155380615537181563710156177915537191553800155380115538021553807155380415537171553808155380915538101553811155381215538131553814155380315638111561797156371315637141563715156371615637171563718156371115638101561798156381215638131563814156381515638161328381155371615637191561790156178115617821561783156178415617851561786156178715637121561789156178015617911561792156179315617941561795156179615638171561788132984013283831329819132983013298311329832132983313298341329817132983613298161329841132984215514351551436155143715514381551439132983513290941328382132838413283851328386132838713283881328389132981813290901551452132909613298101329811132981213298131329814132981513285071551755155171615517171551718155171915517501551751155175215514501551754155171315517561551758155371015537111553712155371315537141551753155155115537151551453155145415514551551456155145715514581551715155155015517141551552155155315515541551699155171015517111551712155145115514591561741155382915544151554416155441715544181554419156037115544131561740155441215617421561743156174415617501561751156175215617531560390155383915638801553831155383215538331553834155383515538361554414155383815617561553870155387115544071554408155440915544101554411155383715638551563846156384715638481563849156385015638511563852156175415638541561773156385615638571563858156385913283801563881155158215638531561765155382815617571561758156175915617601561761156176215638451561764156177415617661561767156176815617691561770156177115617721561755156176315649111553830156490315649041564905156490615649071564908156490115649101564900156491215649131564914156492015649211564922156492315649091563828156381915638201563821156382215638231563824156382515649021563827156492615638291563840156384115638421563843156384415639941563826156641815664051566410156641115664121566413156641415664151564924156641715664021566419156706015670611567062156706315672401567241156641615649651563818156492715649281564929156493015649311564932156640415649341566403156496615649671564968156496915649851564986156498715649251564933132535913253671325351132535213253531325354132535513253561325349132535813253481325360132536113253621325363132536413253651551581132535713253401325331132533213253331325334132533513253361325337132535013253391325368132534113253421325343132534413253451325346132534713253381551573132536615515651551566155156715515681551569155157015515631551572155156215515741551575155157615515771551578155157915515841551571132737113253691325592132559613271551327156132715713271581551564132730213243431551555155155615515571551558155155915515601551561132715913083711325330130737513073761307377130737813073791308360130737313083691307372131017113103711310381131038213103831310384131038513083661307104155175915638821300750130075113007521300753130075413073741307103131371013071051307106130710713071081307109130737013073711307102132230513140091314010131401113140121314013131401413140151310386132230413140061322306132230713223081322309132237113243421551583131401613137731324344131371113137121313713131371413137151313770131400813137721314007131379413140001314001131400213140031314004131400513123241313771132037213203851316436131643713164381316439131830013183011316434132037113164331320373132037413203801320381132038213203831551580132037013071001302778130277913043011304371130439713043991304451131643513044711320386130710113140171314018131401913164301316431131643213044701321599132038413213171321318132131913213201321321132132213213151321324132131413223011322302132230313273801327381132759713276901321323132130613203871320388132038913213001321301132130213213031321316132130513027751321307132130813213091321310132131113213121321313132130415516981302777155169015516911551692155169315516941551695155161815516971551617130076013007611300762130107613014501301451130145215516961551594155158515515861551587155158815515891551590155159115516191551593130145515515951551596155159715515981551599155161515516161551592130276113017651301766130176713017681301769130275013027511301453130276013015521302762130277013027711302772130277313027741328371130275213014641302776130145613014571301458130145913014601301461130155413014631301553130146513014661301467130146813014691301550130155113014541301462158900315890111583835158383615838371583838158383915890001583833158900215838321589004158900515890061589007158900815890091883716158900115838241529043152904415290801529081158381915838201583821158383415838231589012158382515838261583827158382815838291583830158383115838221598198158901015903631590364159036515903661590367159819515903611598197159036015981991883710188371118837121883713188371415838091598196158906215890131589014158901515890161589017158901815890191590362158906115290401589063158906415890651589066158906715890681589069158906015225161529042152250815225091522510152251115225121522513151362815225151513627152251715225181522519152371015237111523712152371315225141513619151361015136111513612151361315136141513615151361615136291513618152371615136201513621151362215136231513624151362515136261513617152386515238361523837152383815238391523860152386115238621523714152386415238331523866152386715517571523868156388315238691883717152386315238051529041152371715237181523719152380015238011523802152383515238041523834152380615238071523808152380915238301523831152383215237151523803138383313838511383826138382713838281383829138383013838311383824150038313838231383834138383513838361383837138383813838391883715138383213838151383806138380713838081383809138381013838111383812138382513838141383852138381613838171383818138381913838201383821138382213838131394908138385013949001394901139490213949031394904139490513939081394907139390713949091394910139491113949121394913139491415003711394906138490213838531383854138385513838561383857138385813838591393909138490113838031384903138490413939021393903139390413939051393906138490015938721383805159371415937151593716159371715937181593719159371215938711593711159387315938741593875159387615938771593878159387915938701593623188371818837191590368159036915903711590399159362015937131593622159390215936241593625159362615936271593628159362915937101593621158381615981921598193159819415838101583811158381215838131593900158381515981891583817158381813837191383800138380113838021509348158381415981811383804159390315939041597840159784115978421597843159819115981801598190159818215981831598184159818515981861598187159818815939011597844151364215093061513710151364915136481513647151364615136451513712151364315137131513641151364015093111509310150930915093081510371151364415138461513890151386915138681513867151386615138651513849151371115138471509305151384515137191513718151371715137161513715151371415138481503616150930715036081503609150361015036111503612150361315036061503615150360515036171503618150361915037101503711150371215093121503614150038815039091503908150390715039061503905150038415003851503607150038715138931500389150039915036001503601150360215036031503604150038615824801513891158248815824871582486158248515824841582483158371015824811583711158039915803891580388158038715803861580385158038415824821583719158380815838071583806158380515838041583803158380215824891583800158038115837181583717158371615837151583714158371315837121583801151883015188391518838151883715188361518835151883415188331580383151883115225011513899151389815138971513896151389515138941509315151883215290831513892158038015803711529089152908815290871529086152037115290841522500152908215225071522506152250515225041522503152250215803821529085139038213938441393713139371213937111393710139038613903851393715139038313937161390381139037113849191384918138491713849111384910139038413938241509313139384213938411393840139382913938281393827139371413938251384907139382313938221393821139382013937191393718139371713938261509341150933215093331509334150933515093361509337150933813849091509340150932915093421509343150934415093451509346150934713803841509339138371213938451384906138490513837181383717138371613837151509331138371315093301383711138371013803991380389138038615093271509328138490813837141503823139384315038311503830150382915038281503827150382615038331503824150383415038221503821150382015038191503818150381715038161503825150932415093491509316150931715093181509319150932015093211503832150932315038131509325150932615038391503838150383715038361503835150932213938531503713139390113939001393859139385813938571393856150381513938541503716139385213938511393850139384913938481393847139384613938551503804150931415038121503811150381015038091503808150380715037141503805150371515038031503802150380115038001503719150371815037171503814150380613460211893714134603013460291346028134602713460261346025134603213460221346033134602013403711893719189371818937171893716136338613460231352642135265113526501352649135264813526471352646135264513460311352643189371313526411352640135255913525581352557134603513460341352644153249218937151533120153249915324981532497153249615324951533380153249315333811532491153249015324891532488153248715324861532485153249418903711893712189371118937101890386189038518903841890383153337118903811352654153438315343821534381153438015343711533383153338218903821360769135265213613831361382136138113613801361371136086913613851360867136138613607681360767136076613592441359243135924213592411360868136238515003801363384136338313633821363381136338013633711361384136238613526881362384136238313623821362381136238013623711361984136298413526591352668135266713526661352665135266413526631352662135924013526601352671135265815003811352657150038213526561352655153248213526611352679135265313526871352686135268513526841352683135268213526691352680135267013526781352677135267613526751352674135267313526721352689135268115672481863715156725615672551567254156725315672521567251156725815672491567259156724715672461567245156724415672431567242156399315672501860382153248418637131863712186371118637101860386186038515672571860383156399018603811860371156908815690871569086156908515690841860384156389115639051563904156390315639021563901156390015638941563992156389215639081563890156388915638881563887156388615638851563884156389315639711863716156397915639781563977156397615639751563974156390615639721563907156397015639291563928156392715639261563925156390915639911563973133838118637141338402133840113384001338386133838513383841338404133838213393701338371133739513373941337393133739213373911337390133838315303821364371153248115324801532474153247315324721532471133840315303831334695153038115303721530371133937413393731339372133937115303841330381133238313323821332381133237113303861330385133038413353801330382133238613303711863902186390118639001863719186371818637171330383133437115324831334694133469313343861334385133438413343831332384133438113323851333386133338513333841333383133338213333811333371133537113343821360399135988813673381367337136733613673351366386136638513673601360764136736113603981360386136038413603821360371136034513592551360765136736913674951367494136749313674921367491136749013673991367339136737113598871367368136736713673661367365136736413673631367362136739713592631359889135980113598001359269135926813592671359266135980313592641359804135926213592611359260135925913592581359257136338513592651359842135988613598851359884135988313598821359881135988013598021359843136749813598411359840135980913598081359807135980613598051359844137834613674961378354137835313783521378351137835013783491378356137834713783571378345137834413783431378342137834113783401374919137834813783651380383138038213803811380371137837113783691378368137835513783661374911137836413783631378362137836113783601378359137835813783671367695136838313683821368381136838013683711367699136769813749181367696137008513676941367693136769213676911367690136749913592541367697137039013674971374910137490913749081374907137490613749051369371137039213700841370386137038413703821370371137008813700871370086137491713703931373388137338013748451374844137484313748421374841137484013748471373389137484813733871373386137338513733841373383137338213748961374038137485613592561374889137488813748871374886137488513748591374846137485713733191374855137485413748531374852137485113748501374849137485813653711373381136539713653861365385136538413653831365382136630113653801366371136438613643851364384136438313643821364381136438013653811370399137331813733171373316137331513721441372143137214213663001372140137489713703981370395136638413663831366382136638113663801372141135234813523401352356135235513523541352353135235213523511352358135234913523591352347135234613523451352344135234313523421374895135235013525561359253135925213592511359250135924913592481359247135235713592451352309135255513525541352553135255213525511352550135237113592461346036135234113460461346045134604413460411346040134603913503711346037135038113749041374903137490213749011374900137489913748981346038135138913523081352307135230613523051352304135230313523021350345135230013803851351380135137113503991350386135038513503841350383135038213523011589686158968215896891589687158968515896841589683158907615890771589078158968115890791589075158968815896801374925137837213749291374928137492713749261378380136837213673301367331136733213673331508307137838113700721367380137492413693721370071136733413703461370372137076613673721509396150830515093901509391150939215093931509003150939515090021509397150939815093991510372151365015136511509394136730613783831503999150830015083011508302150900415083041378382150830613598141508308150830915090001509001150830313353641356900135261913526181890372153437215333721532478133837213373721337371133737013603721335365135690313007591300769130175213027591551486155148715514881551489155150015515011551502155150313353721360346136730413673031366372136630713653721364372136396113633721362983136237213619831361372135690115136521356902152261213598131359812135981113598101356909135690813569071356906135690513569041367305136086215237261582464158246315824621582461158246015803721529049152904815290471529046152904515237291522610152372715824671523725152372415237231523722152372115237201523659152365815236571523656152365515236541523653152372815837201593649159364815936471593646159364515903721583729158372815837271583726158372515837241583723158246515836341599412158246815824691583630158363115837221583633158372115836351583636158363715836381583639158246615836321513889159941415236521523651152365015226191522618152261715226161522615152261415226131593725152261115936661513726151365415137201513721151372215137231551504151372515203721513727151372815137291513887151388815936671513724159372615136531599411159941015993891599388159938715993861599385159938415993831599382159938115993801593665159372015936681593669159368015936811593682159372915936841593728159372115937221593723159372413949501599413159368315637281567261156038415617451561746156179915637201563721156372215637231563724156372515603721563727155440415637291564952156495315649541566406156640715670751567076156707715670781893727156372613290791322372132239913243001324301132430213253001325301132530213253031325304132530515603831325307156906013290821551400155140115514021551480155148115514821551483155148415544011554403132530613460831567079134609513460941346093134609213460911346090134608913460881346087134608613460971346084134609813460821346081134608013403841340383134038213403811340380134037218937291893728134608513346651569061186037218639061863907186390813303721332362133237213333721334368133437213460961334664132132713353631352333135233213523311352330135138313513721350397135037213503461346099133466313849241321329139372513937241393723139372213937211393720139037213849291384928138492713937271384925139372813837291383728138372713837261383725138372413837231383722138372113837201380372138492615037281394951139495213949531394954150037215037201503721150372215037231503724150372513937261503727137838715037291503995150399615039971503998139399913939981393997139386913938681393729150372613140401551505130838513083861308387131017213103621310372131244113124421312443131371913783891313721130644413140411318315131831613193501319351131935213193531319354132132513213261554402131372013525831321328137838613783851378384135261713526161352615135261413526131352612135261115937271352584130837213525821352581135258013523721302769130437213044761306440130644113064421306443137838813526101551508155172815517291551787155187715518791551723155172215517211551720155148518937261551727155150715518781551509155151015515111551512155151315515141551515155151615515171551518155151915517241551506155372915537221551880155372315537241553725155372615517261553728155372115544001893720189372118937221893723189372418937251553727155188515517251551881155188915518881551887155188615537201551882155188315518841567265156373415690781561715156171615617171561718156171915617471563730156373115617131563733156171215637351563736156373715637381563739156496015649611564962156496315637321553738155173515517361551737155373015537311553732155373315537341553735156171415537371566409155373915544281554429156037315603801560381156038215617101561711155373618937311337375133737613383731338380153037315331251533373153437318903731564964189373013353731893732189373318937341893735189373618937371893738189373913403731890380133337313409201378258156726615690791860373186038018639091330373133038013373741332380133737313333801334373133438013346661334667133466813353661335367133536815664081332373159930113782561384937138493615993091599308159930715993061599305159930413849391599302139037315993001593739159373815937371593736159373515937341593733159373215993031393738139496213949611394960139387613938751393874139387313938721393871138493813937391593659139373713937361393735139373413937331393732139373113937301390380139387015225901523646152364515225991522598152259715225961522595152259415225931593731152259115236491520373151373915137381513737151373615137351513734151373315137321522592159038615003731593658159365615936541593653159365215936511593650159038915236471590387152364815903851590373152373115237301523664152366315236621523661152366015937301590388158361615837371583736158373515837341583733158373215837311583730158361915836061583617158938015836151583614158361315836121583611158361015836091583608139496315836181590300159365515517341590309159030815903071590306159030515903041590303158373815903011583739158938915893881589387158938615893851589384158938315893821589381158360515903021503733150831415083131508312150831115083101503739150373815037371503736158360715037341509007150373215037311503730150366415036631503662150366115036601513679150373515237341583604158360315836021583601158360015803731523739152373815237371509005152373515090061523733152373215090341509033150903215090311509030150900915090081394964152373613525081356984135698313569821356981135698013569441356943135694213569411352386135250913569871352507135250613525051352504135250313525021352501135250013623731356940135986715137311361373136039313603731359874135987313598721359871135987013569851359868135698613598661359865135986413598631359862135986113598601356989135698813523851359869134604213462261346225134622413462231346222134622113462201346049134604813523871346043134622913460241341989134198813419871341986134198513409241340923134092213460471346239135238413523731352325135232413523231352322135137313503801350373134622713503431346228134623813462371346236134623513462341346233134623213462311346230136239013503441383737150903615090351384935138493413839091383908138390713839061383905137837313837381509039138373613837351383734138373313837321383731138373013803801361390138373915090491340921151367815136771513676151367515136741513673151367215136711509037151037315090381509048150904715090461509045150904415090431509042150904115090401378259151367013663901370373137034313700731369373136837313673731367354136735313673521380373136735013749351366373136630313653901365373136439013643731363963136339013633731367351137819513782571378255137825413782531378252137825113782501378199137819813707651378196137493413781941378193137819213781911378190137493913749381374937137493615137301378197131405813083801308381130838213084201308421131017313103731310380131373013233801313732130726813140591318309131831013183111322373132237413223751322376132237713137311306936155173315936571300766130175313017541301760130275513027661304373130837313069351307269130693713069381306939130726013072611307262130726413072661307267130726513044751551657155164415516451551646155164715516481551649155165015516511551652155164315516551551654155165815516591551660155166115516621551730155173115517321323381130726315516531326212132338213233831551656155164213233841324328132432913243491326211132621313262141326215132737215516401328373132621015516411327373132837213262191326218132621713262161561726156172415617231561722156172715617251561721156038615603881560387156172815637491560389156172015617481561749156374015637411563742156374315637441563745156374615637481560385132982015638751563876156374715517391365374156387713283741329075132950413298211329823132982413298251329826132984313298441329822155173815603741553740155374115537421553743155374415537451553746155374715537481553749155397515539761329845136298813639661356998135699913598951359896135989713598981359899136037413608431360848136137413569961362374135699513633741327387136437418603741366374136737413673811368374136937413700891370374137076013619881352328134605913462101346211134621213462131346214134621513462161346217134621813462191350374135699713513741563878135232913523741356945135694613569471356948135694913569901356991135699213569931356994135038913271181863971132133613213371321338132133913243331324334132433513243361325370132537113253721319346132537413193451327119132712013271211327122132712313271241327125132712613271271327128132712913273741325373131038813043741306950130695113069521306953130695413080151308016130801713080181308019130836113213351310374156387913137401313741131374213137431313788131378913140621314063131830213183031319343131934413083741340937153437418903741890399189374018937411893742189374318937441893745189374618937471893748132738513409351533385134093813409391346050134605113460521346053134605413460551346056134605713460581300767189374913303991301759156498015649811564982156498315649841566420156642115690891509028186039913733601533399133037415333861332374133239913333741333399133437413346691334670133537413383741530374153039915333741327386186397213837471373365137823613782371378238137823913783741380374138374013837411383742138374313837441378234138374613782331383748138374913839001383901138390213839031383904138498513849861384987138498813849891383745137822015090261373367137336813733691373370137337113733721373373137337413749851374986137498713782351374989151374213782211378222137822313782241378225137822613782271378228137822913782301378231137823213749881583659152909615290971529098152909915803741583650158365115836521583653158365415836551583656151374015836581529093158374015837411583742158374315837441583745158374615837471583748158374915893701589371158365715237401373364151374315137441513745151374615137471513748151374915188501518851151885215188531529095152037415290941523741152374215237431523744152374515237461523747152374815237491529090152909115290921513741151885415038991373366150374615037471503748150374915038901503891150389215038931503894150389515038961503744150389815037431509025130276715090271340374150902915103741513680151368115136821513683151368415136851503897139387813733621390374139039913937401393741139374213937431393744139374513937461393747139374815037451393877151368813938791393890139389113949801394981139498213949831394984150037415037401503741150374213937491599363159374915939901593991159399215939931593994159399515939961593997159399815939991599360151368615993621593746159936415993651599366159936715993681599369159940515994061599407159940815994091373363159936115936331373361151368915893721589373158937415893751589376158937715893781589379159037415936301593748159363215937471593634159363515936361593637159363815936391593740159374115937421593743159374415937451513687159363113409361383758139037513849581384957138495613849551523820138375915803751383757138375613837551383754137218713849541523829137832215238221523823152382415238251523826139039015238281393750152907515290761529077152907815290791370375152382713569591360390136037513592191359218135921713721861359215136198213569581356957135695613569551352539135253813592161365375152375913703401370075136937513683751367375136076213663091361375136437513639801363375136298113623751372185136637515093861509378150938015093811509382150938315136921509385150388915093871509388150938915103751513690152382115093841380375137832313783241378325137832613783271378328150937613783751509375138039013837501383751138375213837531513693137832915237521522480152248115224821522483152248415136911523751151375815237531523754152375515237561523757152375815237501513752151369415136951513696151369715136981513699152037515137511513759151375315137541513755151375615137571352535151375013071761308706130870513087041308375130717913064491307177155178413071751307174130717313071721307171135253713071781553753155397915539781553759155375815537571553756131017515537541310365155375215537511553750155178615517851306448155375515993521599359159935815993571599356159935513071701599353159940215993511599350159389915938981593897159389615993541302756130644713064461306445130469113044791304375159940013027571599401130175713017561301755159940415994031561731
        13043031863973134612113461201346119134611813461171560375186397413461241860390186037515690721569071156642315664221346116135034115093771352375135232713523261351375135076213461221350342134612313461291346128134612713461261346125156494713503751561737156494915637541563753156375215637511563750156375615617381563757156173615617351561734156173315617321352536156173915638691561730156494615649451563999156399815639971563755156399515649481563868156386715638661563865156375915637581563996150375015037571503756150375515037541503753155160715037511503880150368915036881503687150368615036851500390150375215038861589341155160913303751330390133237513323901503758150388715037591503885150388415038831503882150388113949481503888158934815003751593753159375215937511593750159039015937551589349137832115893471589346158934515893441589343158934215903751393865155160613949471394946139494513939961393995159375413938661394949139375913937581393757139375615093791393754139386713233731321382132138313213841321385132337015516081323372131940413233741323375132431613243171324318132431913233711314053131037513137501313751131375213137531313774132138113137761321380131405413183321318333131833413183351327142131377513295031327140159389115938901593759159375815937571593893132909215938941551600155160115516021551603155160415516051593756132737513937531327143132714413271451327146132714715938921327149132714113273881327389132830513283061328375159389513271481373376158934013461131393755134611513721881373393137337513409491373377137337813733791373390137339118937551372189134093318937561893757189375818937591340375134093013461111340932134611013409341340945134094613409471340948137339413409311378244137818713781881378189137824013782411373392137824313781841378245137824613782471378248137824913783201378242137810813749541374955137495613749571374958137810513781861378107137818513781091378180137818113781821378183134611213781061583695158375215837511583750158369915836981393752158369615837551583694158369315836921583691158369015803901583697158867115886791588678158867715886761588675158867415837531588672189375415886701583759158375815837571346114158375415886731890375133937513393761339377133937813393791533375133840615343881533390189039018937501893751189375218937531393751158375615343751334375133337515343871333390133840513343901334399133440013346711334672133467313353751338375133839013383991553769131373913137601551892155376015537611553762155376315537641553765155376615544061553768131373815544051597859159785813033701597857155376713033781503769159785613103761303371130337313033741303375130337213033771313737130337913043761307494130837613101761310397131240313137361303376135260415225341350376135076013513761352376135238813523891352390135239713087011352600159785513462081352603134620713526051352606135260713782911378292137829313782941378295137829613782971378298137829913526021341998189376118937621893763189376418937651893766189376718937681893769134037613403971341995134620913419971380376134199913461511346152134615313461541346200134620113462021346203134620413462051346206134199613949161393767139376813937691393970139397113939721393973139397413939751393976139397713939781378376139491513937601394917139491813949191522470152247115224721522473152247415225301522531152253215225331393979138397315343971383760138376113837621383763138376413837651383766138376713837681383769138397013937641383972139376113839741383975138397613839771383978138397913849721384973138497413849751384976139037613783971383971151944815139791518825151882615188271518828151882915188551518856151885715188581518859151944513193861519447151397615194491520376131376113137621313763131376413140601314061131746413183361318337189376015194461508349150397015039711503972150397315039741503975150397615039771503978150397915083451508346151397815083481513977151037615137601513761151376215137631513764151376515137661513767151376815137691513975131938715083471551859155142215514231551424155142515514261551427155142815514291551431155143215514331551760131938515518581329599155189015518911335369133537613383761338397153037615333761533397153437615343901352601155176113253811319388131938913213861321387132138813213891323376132337713233781323397132433013243311551421132538015514041325382132538313253841325385132711213271131327376132739713283071328376132839713290991890376132433215637641583970156642415649181564916156491515638621563861156386015637691563768156376715670651563765156726815637631563762156376115637601560376155443515544341554433155443215544311356977156376613343761356976135697513569741356973135697213569711356970135260913526081334676133467515670641334397158397113333971333376133239713323761330397133037618639701860397186037615690831567269133467415937661554430159382815938271593826159382515938241593823159382215938211593820159376915939701593767159397115937651593764159376315937621593761159376015903971590376158397915839781583977159376815978381583972158397315839741583975158397615978541522535159785313523991597852159785115938291597839156491915978371597836159783515939791593978159397715939761593975159397415939731593972159785015837661500376152902515290261529027152902815290291580376158039715837601583761158376215837631529023156491715290221356978158376815837691503768150376715037661503765150376415037631503762150376115037601500397158376415236751522536152253715225381522539152364015236411523642152364315236441523670152367115236721529024152367415837671523676152376015237611523762152376315237641523765152376615237671523768152376915290201529021152367313673761372311
        13673081367309136734513673461367347136637613673491583765136837613683971369376136939713700761372310136734813613761356979';
        $arr=explode('',$startStr);
        array_pop($arr);
        $str='';
        for($i=0;$i<10020;$i++){
            $startNum=trim($arr[array_rand($arr)]);
            $endNum=mt_rand(1000,9999);
            $telNum=$startNum.$endNum;
            $str.=$telNum.'<br/>';
        }
        echo $str;
    }
    public function delData(){
        $dataArr=array();
        foreach($dataArr as $key=>$val){
            $map['cardno']=$val['cardno'];
            $cardInfo=D('cards')->where($map)->find();
            $map1=array('customid'=>$cardInfo['customid'],'type'=>'00');
            $data1=array('amount'=>0);
            if(D('account')->where($map1)->save($data1)){
                echo 'Yeah<br/>';
            }

            $card_purchase=D('card_purchase_logs')->where($map)->field('purchaseid')->find();
            $map2=array('purchaseid'=>$card_purchase['purchaseid']);
            if(D('custom_purchase_logs')->where($map2)->delete()){
                echo '111<br/>';
            }
            if(D('card_purchase_logs')->where($map)->delete()){
                echo '222<br/>';
            }
            D('card_purchase_logs')->where($map)->delete();
        }
    }
    public function cleanReturnCards(){
        $cardArr=array();
        $model=new Model();
        foreach($cardArr as $key=>$val){
            $cardno=trim($val['cardno']);
            $model->startTrans();
            $where=array('cardno'=>$cardno);
            $card=$model->table('cards')->field('customid')->where($where)->find() ;
            $accountMap=array('customid'=>$card['customid']);
            M('account')->where($accountMap)->delete();
            echo $model->getLastSql()."<br/>";
            $customscMap=array('cid'=>$card['customid']);
            $customsc=M('customs_c')->where($customscMap)->find();
            M('customs_c')->where($customscMap)->delete();
            echo $model->getLastSql()."<br/>";
            $customsMp=array('customid'=>$customsc['customid']);
            M('customs')->where($customsMp)->delete();
            echo $model->getLastSql()."<br/>";
            M('trade_wastebooks')->where($where)->delete();
            echo $model->getLastSql()."<br/>";
            M('cards')->where($where)->delete();
            echo $model->getLastSql()."<br/>";
            //exit;
//            $cardplMap=array('cardno'=>$cardno);
//            $cardpllist=M('card_purchase_logs')->where($cardplMap)->select();
//            //print_r($cardpllist);exit;
//            foreach($cardpllist as $key=>$value){
//                $purchaseid=$value['purchaseid'];
//                $customplMap=array('purchaseid'=>$purchaseid);
//                M('custom_purchase_logs')->where($customplMap)->delete();
//                echo $model->getLastSql()."<br/>";
//            }
//            M('card_purchase_logs')->where($cardplMap)->delete();
//            echo $model->getLastSql()."<br/>";
//            $cardalMap=array('cardno'=>$cardno);
//            M('card_active_logs')->where($cardalMap)->delete();
//            echo $model->getLastSql()."<br/>";

//            $quanczMap=array('customid'=>$card['customid']);
//            $quanList=M('quancz')->where($quanczMap)->select();
//            if($quanList!=false){
//                M('quancz')->where($quanczMap)->delete();
//                echo $model->getLastSql()."<br/>";
//            }
//            $cardData=array('status'=>'N','customid'=>0);
//            M('cards')->where($where)->save($cardData);
//            echo $model->getLastSql()."<br/>";

            $model->commit();
            //$model->rollback();
        }
    }

    public function creatRandNum(){
        $array=array('X','1','2','3','4','5','6','7','8','9');
        //$array=array('X','A','B','C');
        $b="";
        for($j=0;$j<250;$j++){
            $a="";
            for($i=0;$i<6;$i++){
                $key=array_rand($array,1);
                $a.=$array[$key];
            }
            $b.=$a.'<br/>';
        }
        echo $b;
    }
    public function cleanCoinData(){
        $list=M('coin_account')->select();
        $sql='';
        foreach($list as $key=>$val){
            $sql.="UPDATE ACCOUNT SET AMOUNT=0 WHERE CUSTOMID='{$val['cardid']}' AND TYPE='01';<br/>";
//            $data=array('amount'=>0);
//            M('account')->where($map)->save($data);
           // echo M('account')->getLastSql().'<br/>';
        }
        echo $sql;
    }
    public function cleanCoinConsume(){
        $map=array();
        $list=M('coin_consume')->where($map)->select();
        $sql='';
        foreach($list as $key=>$val){
            $sql.="DELETE FROM TRADE_WASTEBOOKS WHERE TRADEID='{$val['tradeid']}';<br/>";
//            $data=array('amount'=>0);
//            M('account')->where($map)->save($data);
            // echo M('account')->getLastSql().'<br/>';
        }
        echo $sql;
    }

    public function changePwd(){
        $pwdArray=array();
        $data=array();
        $sql="";
        foreach($data as $key=>$val){
            $cardno=$val['cardno'];
            $pwd=$pwdArray[$val['pwd']];
            $sql.="UPDATE CARDS SET CARDPASSWORD='BFD0C613A11BF88E' WHERE CARDNO='{$cardno}';<br/>";
            //$sql.="UPDATE CARDS SET CARDPASSWORD='{$pwd}' WHERE CARDNO='{$cardno}';<br/>";
        }
        echo $sql;
    }

    public function cleanCards(){
        //exit('123');
        $array=array(
            array("cardno"=>"6889374888800004200"),
            array("cardno"=>"6889374888800004201"),
            array("cardno"=>"6889374888800004202"),
            array("cardno"=>"6889374888800004203"),
            array("cardno"=>"6889374888800004204"),
            array("cardno"=>"6889374888800004205"),
            array("cardno"=>"6889374888800004206"),
            array("cardno"=>"6889374888800004207"),
            array("cardno"=>"6889374888800004208"),
            array("cardno"=>"6889374888800004209"),
            array("cardno"=>"6889374888800004210"),
            array("cardno"=>"6889374888800004211"),
            array("cardno"=>"6889374888800004212"),
            array("cardno"=>"6889374888800004213"),
            array("cardno"=>"6889374888800004214"),
            array("cardno"=>"6889374888800004215"),
            array("cardno"=>"6889374888800004216"),
            array("cardno"=>"6889374888800004217"),
            array("cardno"=>"6889374888800004218"),
            array("cardno"=>"6889374888800004219"),
            array("cardno"=>"6889374888800004220"),
            array("cardno"=>"6889374888800004221"),
            array("cardno"=>"6889374888800004222"),
            array("cardno"=>"6889374888800004223"),
            array("cardno"=>"6889374888800004224"),
            array("cardno"=>"6889374888800004348"),
            array("cardno"=>"6889374888800004349"),
            array("cardno"=>"6889374888800004350"),
            array("cardno"=>"6889374888800004351"),
            array("cardno"=>"6889374888800004352"),
            array("cardno"=>"6889374888800004353"),
            array("cardno"=>"6889374888800004354"),
            array("cardno"=>"6889374888800004355"),
            array("cardno"=>"6889374888800004356"),
            array("cardno"=>"6889374888800004357"),
            array("cardno"=>"6889374888800004358"),
            array("cardno"=>"6889374888800004359"),
            array("cardno"=>"6889374888800004360"),
            array("cardno"=>"6889374888800004361"),
            array("cardno"=>"6889374888800004363"),
            array("cardno"=>"6889374888800004364"),
            array("cardno"=>"6889374888800004365"),
            array("cardno"=>"6889374888800004366"),
            array("cardno"=>"6889374888800004367"),
            array("cardno"=>"6889374888800004368"),
            array("cardno"=>"6889374888800004369"),
            array("cardno"=>"6889374888800004370"),
            array("cardno"=>"6889374888800004371"),
            array("cardno"=>"6889374888800004372"),
            array("cardno"=>"6889374888800004373"),
            array("cardno"=>"6889374888800004374"),
            array("cardno"=>"6889374888800004375"),
            array("cardno"=>"6889374888800004376"),
            array("cardno"=>"6889374888800004377"),
            array("cardno"=>"6889374888800004378"),
            array("cardno"=>"6889374888800004379"),
            array("cardno"=>"6889374888800004380"),
            array("cardno"=>"6889374888800004381"),
            array("cardno"=>"6889374888800004382"),
            array("cardno"=>"6889374888800004383"),
            array("cardno"=>"6889374888800004384"),
            array("cardno"=>"6889374888800004385"),
            array("cardno"=>"6889374888800004386"),
            array("cardno"=>"6889374888800004387"),
            array("cardno"=>"6889374888800004388"),
            array("cardno"=>"6889374888800004225"),
            array("cardno"=>"6889374888800004226"),
            array("cardno"=>"6889374888800004227"),
            array("cardno"=>"6889374888800004229"),
            array("cardno"=>"6889374888800004230"),
            array("cardno"=>"6889374888800004246"),
            array("cardno"=>"6889374888800004248"),
            array("cardno"=>"6889374888800004249"),
            array("cardno"=>"6889374888800004250"),
            array("cardno"=>"6889374888800004251"),
            array("cardno"=>"6889374888800004252"),
            array("cardno"=>"6889374888800004253"),
            array("cardno"=>"6889374888800004254"),
            array("cardno"=>"6889374888800004255"),
            array("cardno"=>"6889374888800004256"),
            array("cardno"=>"6889374888800004257"),
            array("cardno"=>"6889374888800004258"),
            array("cardno"=>"6889374888800004260"),
            array("cardno"=>"6889374888800004261"),
            array("cardno"=>"6889374888800004262"),
            array("cardno"=>"6889374888800004263"),
            array("cardno"=>"6889374888800004264"),
            array("cardno"=>"6889374888800004265"),
            array("cardno"=>"6889374888800004389"),
            array("cardno"=>"6889374888800004390"),
            array("cardno"=>"6889374888800004391"),
            array("cardno"=>"6889374888800004392"),
            array("cardno"=>"6889374888800004393"),
            array("cardno"=>"6889374888800004394"),
            array("cardno"=>"6889374888800004395"),
            array("cardno"=>"6889374888800004396"),
            array("cardno"=>"6889374888800004397"),
            array("cardno"=>"6889374888800004398"),
            array("cardno"=>"6889374888800004399"),
            array("cardno"=>"6889374888800004400"),
            array("cardno"=>"6889374888800004401"),
            array("cardno"=>"6889374888800004402"),
            array("cardno"=>"6889374888800004403"),
            array("cardno"=>"6889374888800004404"),
            array("cardno"=>"6889374888800004405"),
            array("cardno"=>"6889374888800004406"),
            array("cardno"=>"6889374888800004407"),
            array("cardno"=>"6889374888800004408"),
            array("cardno"=>"6889374888800004409"),
            array("cardno"=>"6889374888800004410"),
            array("cardno"=>"6889374888800004411"),
            array("cardno"=>"6889374888800004412"),
            array("cardno"=>"6889374888800004413"),
            array("cardno"=>"6889374888800004414"),
            array("cardno"=>"6889374888800004415"),
            array("cardno"=>"6889374888800004416"),
            array("cardno"=>"6889374888800004417"),
            array("cardno"=>"6889374888800004418"),
            array("cardno"=>"6889374888800004419"),
            array("cardno"=>"6889374888800004420"),
            array("cardno"=>"6889374888800004421")
        );
        $sql='';
//        $activeLog=M('card_active_logs');
//        $cardpl=M('card_purchase_logs');
//        $custompl=M('custom_purchase_logs');
//        $auditLog=M('audit_logs');
//        foreach($array as $key=>$val){
//            $linktel=$val['linktel'];
//            $sql.="delete from customs where linktel='{$linktel}' and countrycode='君邻会会员';<br/>";
//        }
        $model=new Model();
        foreach($array as $key=>$val){
            $model->startTrans();
            $cardno=$val['cardno'];
            $map=array('cardno'=>$cardno);
            $card=$model->table('cards')->where($map)->find();
            $cardid=$card['customid'];
            $map1=array('cid'=>$cardid);
            $custom=$model->table('customs_c')->where($map1)->field('customid')->find();
            //$map5=array('customid'=>$custom['customid']);
            //$model->table('customs')->where($map5)->delete();
            echo $model->getLastSql().';<br/>';
            $map11=array('cid'=>$cardid,'customid'=>$custom['customid']);
            $model->table('customs_c')->where($map11)->delete();
            echo $model->getLastSql().';<br/>';
            $map2=array('customid'=>$cardid);
            $model->table('account')->where($map2)->delete();
            echo $model->getLastSql().';<br/>';
            $map3=array('cardno'=>$cardno);
            $model->table('card_active_logs')->where($map3)->delete();
            echo $model->getLastSql().';<br/>';
            $cardpls=$model->table('card_purchase_logs')->where($map3)->field('purchaseid')->select();
            foreach($cardpls as $k=>$v){
                $where=array('purchaseid'=>$v['purchaseid'],'customid'=>$custom['customid']);
                $model->table('custom_purchase_logs')->where($where)->delete();
                echo $model->getLastSql().';<br/>';

                $map5=array('purchaseid'=>$v['purchaseid']);
                $adutid= $model->table('audit_logs')->where($map5)->max('auditid');
                $map6=array('purchaseid'=>$v['purchaseid'],'auditid'=>$adutid);
                $model->table('audit_logs')->where($map6)->delete();
                echo $model->getLastSql().';<br/>';
            }
            $model->table('card_purchase_logs')->where($map3)->delete();
            echo $model->getLastSql().';<br/>';
            $data4=array('status'=>'N','customid'=>0);
            $model->table('cards')->where($map3)->save($data4);
            echo $model->getLastSql().';<br/>';

            $model->table('trade_wastebooks')->where($map)->delete();
            echo $model->getLastSql().';<br/>';

            $map5=array('customid'=>$cardid);
            $model->table('quancz')->where($map5)->delete();
            echo $model->getLastSql().';<br/>';
            echo $custom['customid'].';<br/>';

            $model->table('ecard_bind')->where(array('cardno'=>$cardno))->delete();

            $model->table('coin_account')->where(array('cardid'=>$cardid))->delete();

            $model->table('coin_consume')->where(array('cardid'=>$cardid))->delete();
            $model->table('fangzg_c')->where(array('cardno'=>$cardno))->delete();
            $model->commit();
        }
        //$model->rollback();
        //$model->commit();
    }
    public function createSql1(){
        $array=array();
        $sql='';
        $cardpl=M('card_purchase_logs');
        $custompl=M('custom_purchase_logs');
        $cards=M('cards');
        $customsc=M('customs_c');
        foreach($array as $key=>$val){
            $cardno=$val['cardno'];
            $customid=$val['customid'];
            $map1=array('cardno'=>$cardno,'placeddate'=>'20160420');
            $list1=$cardpl->where($map1)->field('purchaseid')->find();
            $purchaseid=$list1['purchaseid'];
            $map2=array('purchaseid'=>$purchaseid,'placeddate'=>'20160420');
            $list2=$custompl->where($map2)->field('customid')->find();
            $map3=array('cardno'=>$cardno);
            $list3=$cards->where($map3)->field('customid')->find();
            $map4=array('cid'=>$list3['customid']);
            $list4=$customsc->where($map4)->select();

            if(count($list4)==0){
                $sql.="insert into customs_c values('{$list2['customid']}','{$list3['customid']}');<br/>";
            }else{
                $sql.=$cardno.'<br/>';
            }
        }
        echo $sql;
    }

    public function createSql(){
        $array=array();
        $trade=M('trade_wastebooks');
        $sql='';
        foreach($array as $key=>$val){
            //$val['amount'].'--'.$list['tradepoint'].'---'.
            $map=array('eorderid'=>'e+_0001-'.$val['eorderid']);
            $list=$trade->where($map)->field('tradeid,tradepoint')->find();
//            if($list['tradepoint']!=$val['amount']){
//                echo '0<br/>';
//            }else{
//                echo '1<br/>';
//            }
            $sql.="update trade_wastebooks set panterid='{$val['panterid']}',termno='00000001',termposno='0000001' where tradeid='{$list['tradeid']}';<br/>";
            $sql.="update coin_consume set panterid='{$val['panterid']}' where tradeid='{$list['tradeid']}';<br/>";
        }
        echo $sql;
        exit;
        $sql='';
        //$cardal=M('card_active_logs');
        //$cardpl=M('card_purchase_logs');
        //$custompl=M('custom_purchase_logs');
        foreach($array as $key=>$val){
            $cardno=$val['areaname'];
            $cityname=$val['cityname'];
            $sql.="insert into wy_area values ('{$val['areaname']}','{$val['cityname']}','');<br/>";
//            $cardno=$val['cardno'];
//            $sql.="UPDATE CARDS SET PANTERID='00000324' WHERE CARDNO='{$cardno}';<br/>";
            //$sql.="UPDATE CARDS SET CARDFEE=1 WHERE CARDNO='{$cardno}';<br/>";
//            $customid=$val['customid'];
//            $cid=$val['cid'];
//            $sql.="DELETE FROM CUSTOMS_C WHERE CUSTOMID='{$customid}' and cid='{$cid}';<br/>";
            /*$map=array('cardno'=>$cardno);
            $sql.="UPDATE CARD_ACTIVE_LOGS SET USERID='0000000000000087' where cardno='{$cardno}';<br/>";
            //$sql.="UPDATE CARD_PURCHASE_LOGS SET PLACEDDATE='20160420' where cardno='{$cardno}';<br/>";
            $list=$cardpl->where($map)->field('purchaseid')->find();
            $purchaseid=$list['purchaseid'];
            $sql.="UPDATE CUSTOM_PURCHASE_LOGS SET CHECKID='0000000000000087' WHERE PURCHASEID='{$purchaseid}';<br/>";
            //$sql.="UPDATE audit_logs SET PLACEDDATE='20160420' WHERE PURCHASEID='{$purchaseid}';<br/>";*/
        }
        echo $sql;
    }
    public function test1(){
        $a=$this->getNextcardno('6888',8);
        echo $a;
    }

    public function updateDate(){
        $array=array();
        $model=new Model();
        $sql='';
        $card_purchase_logs=M('card_purchase_logs');
        foreach($array as $key=>$val){
            $cardno=$val['cardno'];
            $sql.="update card_active_logs set activedate='20160429' where cardno='{$cardno}';<br/>";
            $sql.="update card_purchase_logs set placeddate='20160429' where cardno='{$cardno}';<br/>";
            $map=array('cardno'=>$cardno,'placeddate'=>'20160509');
            $cardpl=$card_purchase_logs->where($map)->find();
            $purchaseid=$cardpl['purchaseid'];
            $sql.="update custom_purchase_logs set placeddate='20160429',checkdate='20160429' where purchaseid='{$purchaseid}';<br/>";
            $sql.="update audit_logs set placeddate='20160429' where purchaseid='{$purchaseid}';<br/>";
        }
        echo $sql;
    }

    public function addCustoms(){
        //$customid=$this->getnextcode('customs',8);
        $customid=$this->getFieldNextNumber('customid');
        $nameArr=array(
            array('namechinese'=>'王翠英','linktel'=>'13837153810','personid'=>'410105197812264462')
        );
        $model=new Model();
        foreach($nameArr as $val){
            //$customid=$this->getnextcode('customs',8);
            $customid=$this->getFieldNextNumber('customid');
            $namechinese=$val['namechinese'];
            $linktel=$val['linktel'];
            $personid=$val['personid'];
            $sql="insert into customs(customid,namechinese,placeddate,customlevel,linktel,personid) ";
            $sql.="values('{$customid}','{$namechinese}','".date('Ymd')."','建业线上会员')";
            $model->execute($sql);
        }
    }

    public function test2(){
        $array=array();
        $fangzgc=M('fangzg_c');
        $cardpl=M('card_purchase_logs');
        foreach($array as $key=>$val){
            $cardno=$val['cardno'];
            $map=array('cardno'=>$cardno,'tradeid'=>array('EXP','IS NOT NULL'));
            $list=$fangzgc->where($map)->find();
            if(!empty($list)){
                $map2=array('cardno'=>$cardno);
                $list2=$cardpl->where($map2)->field('card_purchaseid')->find();
                $card_purchaseid=$list2['card_purchaseid'];
                $data=array('card_purchaseid'=>$card_purchaseid);
                $map3=array('cardno'=>$cardno,'tradeid'=>$list['tradeid']);
                $fangzgc->where($map3)->save($data);
                echo $fangzgc->getLastSql();
            }

        }
    }

    //检测手机号是否注册
    public function jlhCheckCustom(){
        if (!empty( $_FILES['file_stu']['name'])) {
            $m=$n=0;
            set_time_limit(0);
            $tmp_file = $_FILES ['file_stu'] ['tmp_name'];
            $file_types = explode(".", $_FILES ['file_stu'] ['name']);
            $file_type = $file_types [count($file_types) - 1];
            /*判别是不是.xls文件，判别是不是excel文件*/
            if (strtolower($file_type) != "xls" && strtolower($file_type) != "xlsx") {
                $this->error('不是Excel文件，重新上传');
            }
            /*设置上传路径*/
            $savePath = './Public/upfile/Excel/';
            /*以时间来命名上传的文件*/
            $str = date('Ymdhis');
            $file_name = $str . "." . $file_type;
            /*是否上传成功*/
            if (!copy($tmp_file, $savePath . $file_name)) {
                $this->error('上传失败');
            }
            $exceldate = $this->import_excel($savePath . $file_name, 1);
            $arr=$array=array();
            foreach($exceldate as $k=>$v){
                $arr['cardno']=$v[1];
                $arr['namechinese']=$v[2];
                $arr['sex']=$v[3];
                $arr['personid']=$v[5];
                $arr['linktel']=$v[4];
                $arr['unitname']=$v[6];
                $array[]=$arr;
            }

            foreach($array as $key=>$val){
                $linktel=trim($val['linktel']);
                $map=array('linktel'=>$linktel,'customlevel'=>'建业线上会员');
                $custom=M('customs')->where($map)->find();
                if($custom==false){
                    $jlh1[]=$val;//未注册过手机号
                }else{
                    $jlh[]=$val;//注册过手机号
                }
            }
            if(count($jlh1)>0){
                $m=$this->jlh($jlh1,1);
            }
            if(count($jlh)>0){
                $n=$this->jlh($jlh,2);
            }
            $counts=$m+$n;
            $this->success('会员批量开卡成功'.$counts.'条',U('App/jlhCheckCustom'));
        }
        $this->display();
    }

    //君邻会新会员导入（注册过手机号）
    public function jlh($array,$type){
        $sql='';
        $m=0;
        foreach($array as $key=>$val){
            $linktel=trim($val['linktel']);
            $namechinese=$val['namechinese'];
            $sex=$val['sex'];
            $personid=$val['personid'];
            $unitname=$val['unitname'];
            $this->model->startTrans();
            if($type==1){
                $customid=$this->getFieldNextNumber('customid');
                $currentDate=date('Ymd');
                if($key==0){
                    $sql.="INSERT ALL INTO CUSTOMS (CUSTOMID,LINKTEL,NAMECHINESE,SEX,PERSONID,UNITNAME,CUSTOMLEVEL,PLACEDDATE,COUNTRYCODE) VALUES";
                    $sql.=" ('{$customid}','{$linktel}','{$namechinese}','{$sex}','{$personid}','{$unitname}','建业线上会员','{$currentDate}','君邻会会员')";
                }else{
                    $sql.=" INTO CUSTOMS (CUSTOMID,LINKTEL,NAMECHINESE,SEX,PERSONID,UNITNAME,CUSTOMLEVEL,PLACEDDATE,COUNTRYCODE) VALUES";
                    $sql.=" ('{$customid}','{$linktel}','{$namechinese}','{$sex}','{$personid}','{$unitname}','建业线上会员','{$currentDate}','君邻会会员')";
                }
                $cardArr[]=$val['cardno'];
            }else{
                $map=array('linktel'=>$linktel,'customlevel'=>'建业线上会员');
                $customInfo=M('customs')->where($map)->find();
                $customid=$customInfo['customid'];
                $sql="UPDATE  CUSTOMS SET NAMECHINESE='{$namechinese}',SEX='{$sex}',PERSONID='{$personid}',UNITNAME='{$unitname}' where customid='{$customid}'";
                $customIf=$this->model->execute($sql);
                if($customIf==true){
                    $cardArr=array($val['cardno']);
                    $bool=$this->openCard($cardArr,$customid);
                    if($bool==true){
                        ++$m;
                        $this->model->commit();
                        if($key==count($array)-1){
                            return  $m;
                        }
                    }else{
                        $this->model->rollback();
                    }
                }else{
                    $this->model->rollback();
                }
            }
        }
        if($type==1){
            $sql.=" SELECT 1 FROM DUAL";
            $customIf=$this->model->execute($sql);
            if($customIf==true){
                $bool=$this->openCard($cardArr,$customid);
                if($bool==true){
                    $this->model->commit();
                    return  count($array);
                }else{
                    $this->model->rollback();
                }
            }else{
                $this->model->rollback();
            }
        }
    }

    protected function openCard($cardArr,$customid,$amount=0){
        if(empty($cardArr)) return false;
        $userid=$this->userid;
        $rechargedAmount=0;
        foreach($cardArr as $key=>$val){
            $waitMoney=$amount-$rechargedAmount;
            $cardno=$val;
            $userstr= substr($userid,12,4);
            $purchaseid=$this->getFieldNextNumber('purchaseid');
            $purchaseid=$userstr.$purchaseid;
            $currentDate=date('Ymd');
            $checkDate=date('Ymd');
            $where['cardno']=$cardno;
            $cardinfo=M('cards')->where($where)->field('panterid')->find();
            if($amount==0){
                $rechargeMoney=0;
            }else{
                if($waitMoney>=5000){
                    $rechargeMoney=5000;
                }else{
                    $rechargeMoney=$waitMoney;
                }
            }
            //写入购卡单并审核
            $customplSql="insert into custom_purchase_logs values('".$customid."','".$purchaseid."','".$currentDate."','现金','";
            $customplSql.=$this->userid."','{$rechargeMoney}',NULL,'{$rechargeMoney}',0,'{$rechargeMoney}','{$rechargeMoney}'";
            $customplSql.=",1,'','购卡','1','{$cardinfo['panterid']}','".$userid."',NULL,'0',";
            $customplSql.="'0',NULL,'00000000','".date('H:i:s')."','".$checkDate."','".date('H:i:s',time()+300)."',NULL)";
            $customplIf=$this->model->execute($customplSql);

            //写入审核单
            $auditid=$this->getFieldNextNumber('auditid');
            $auditlogsSql="insert into audit_logs values ('".$auditid."','".$purchaseid."','审核通过',";
            $auditlogsSql.="'购卡审核通过','".date('Ymd')."','".$userid ."','".date('H:i:s',time()+300)."')";
            $auditlogsIf=$this->model->execute($auditlogsSql);

            //写入购卡充值单
            $cardpurchaseid=$this->getFieldNextNumber('cardpurchaseid');
            $cardplSql="INSERT INTO card_purchase_logs VALUES('{$cardpurchaseid}','{$purchaseid}',";
            $cardplSql.="'{$cardno}','{$rechargeMoney}','0','".$currentDate."','".date('H:i:s',time()+300)."','1','后台充值',";
            $cardplSql.="'{$userid}','{$cardinfo['panterid']}','','00000000')";
            $cardplIf=$this->model->execute($cardplSql);

            $where1['customid']=$customid;
            $card=$this->model->table('cards')->where($where1)->find();
            if($card==false){
                //看会员编号一致的卡是否存在，不存在，以会员编号作为卡的编号
                $cardId=$customid;
            }else{
                //若存在，则需另外生成卡编号
                $cardId=$this->getFieldNextNumber('customid');
                $customSql="UPDATE customs SET cardno='teshu' where customid='".$customid."'";
                $customIf=$this->model->execute($customSql);
            }

            //执行激活操作
            $cardAlSql="INSERT INTO card_active_logs VALUES('{$cardno}','{$userid}',".date('Ymd');
            $cardAlSql.=",'0','Y','00',".date('Ymd').",'".date('H:i:s')."','售卡激活','{$cardId}'";
            $cardAlSql.=",'{$cardinfo['panterid']}','00000000')";
            $cardAlIf=$this->model->execute($cardAlSql);

            //关联会员卡号
            $customcSql="INSERT INTO customs_c(customid,cid) VALUES('".$customid."','".$cardId."')";
            $customsIf=$this->model->execute($customcSql);

            //更新卡状态为正常卡，更新卡有效期；
            $exd=date('Ymd',strtotime("+3 years"));
            $cardSql="UPDATE cards SET status='Y',customid='{$cardId}',cardbalance='{$rechargeMoney}',exdate='{$exd}' where cardno='".$cardno."'";
            $cardIf=$this->model->execute($cardSql);

            //给卡片添加账户并给账户充值
            $acid = $this->getFieldNextNumber('accountid');
            $balanceSql="INSERT INTO account(accountid,customid,amount,type,quanid) VALUES('";
            $balanceSql.=$acid."','".$cardId."','".$rechargeMoney."','00',NULL)";
            $balanceIf=$this->model->execute($balanceSql);

            $acid = $this->getFieldNextNumber('accountid');
            $pointSql="INSERT INTO account(accountid,customid,amount,type,quanid) VALUES('";
            $pointSql.=$acid."','".$cardId."','0','01',NULL)";
            $pointIf=$this->model->execute($pointSql);

            if($customplIf==true&&$auditlogsIf==true&&$cardplIf==true&&$cardAlIf==true&&$customsIf==true&&$cardIf==true&&$balanceIf==true&&$pointIf==true){
                $rechargedAmount+=$rechargeMoney;
            }
        }
        if(!bccomp($rechargedAmount,$amount,2)){
            return true;
        }else{
            return false;
        }
    }

    //导入老卡信息
    public function test(){
        $array=array();
        $cards=M('cards');
        foreach($array as $key=>$val){
            $cardno=$val['cardno'];
            $amount=$val['amount'];
            $name=$val['name'];
            //$customid=$this->getnextcode('customs',8);
            $customid=$this->getFieldNextNumber('customid');
            $placeddate=date('Ymd');
            $map=array('cardno'=>$cardno);
            $card=$cards->where($map)->field('customid')->find();
            //var_dump($card);exit;
//            if($card==false){
//                echo '1<br/>';
//            }else{
//                echo '0<br/>';
//            }
            if($card==false){
                $this->model->startTrans();
                $customSql="insert into customs(customid,namechinese,placeddate,panterid) values('{$customid}','{$name}','{$placeddate}','FFFFFFFF')";
                $customIf=$this->model->execute($customSql);
                $cardSql="insert into cards(customid,cardno,status,panterid,cardpassword,exdate,groupid，dcflag,makedate,cardfee) ";
                $cardSql.="values ('{$customid}','{$val['cardno']}','Y','FFFFFFFF','BFD0C613A11BF88E','20190101','FFFFFFFF',0,'20170727',1)";
                $cardIf=$this->model->execute($cardSql);

                $amount=$val['amount'];

                if($customIf==true){
                    $openIf=$this->openCard(array($cardno),$customid,$amount);
                }else{
                    $this->model->rollback();
                    echo '创建会员失败<br/>';
                }

                if($openIf==true){
                    $this->model->commit();
                }else{
                    $this->model->rollback();
                }
//                $customcSql="insert into customs_c values('{$customid}','{$customid}')";
//                $customcIf=$this->model->execute($customcSql);
//                //$acid = $this->getnextcode('account',8);
//                $acid=$this->getFieldNextNumber('accountid');
//                $balanceSql="INSERT INTO account(accountid,customid,amount,type,quanid) VALUES('";
//                $balanceSql.=$acid."','".$customid."','0','00',NULL)";
//                $balanceIf=$this->model->execute($balanceSql);
//
//                //$acid = $this->getnextcode('account',8);
//                $acid=$this->getFieldNextNumber('accountid');
//                $coinSql="INSERT INTO account(accountid,customid,amount,type,quanid) VALUES('";
//                $coinSql.=$acid."','".$customid."','0','01',NULL)";
//                $coinIf=$this->model->execute($coinSql);
//
//                //$acid = $this->getnextcode('account',8);
//                $acid=$this->getFieldNextNumber('accountid');
//                $pointSql="INSERT INTO account(accountid,customid,amount,type,quanid) VALUES('";
//                $pointSql.=$acid."','".$customid."','0','04',NULL)";
//                $pointIf=$this->model->execute($pointSql);
//                if($customIf==true&&$cardIf==true&&$customcIf==true&&$balanceIf==true&&$pointIf==true&&$coinIf==true){
//                    $this->model->commit();
//                }else{
//                    $this->model->rollback();
//                }
            }
        }
    }

    public function test222(){
        $array=array();
        $model=new Model();
        foreach($array as $key=>$val){
            $cardno=$val['cardno'];
            $map=array('c.cardno'=>$cardno);
            $custom=$model->table('cards')->alias('c')->join('customs_c cc on c.customid=cc.cid')
                ->join('customs cu on cu.customid=cc.customid')->field('cu.customid')->where($map)->find();
            //print_r($custom);exit;
            $map3=array('cardno'=>$cardno);
            $model->table('card_active_logs')->where($map3)->delete();
            echo $model->getLastSql().';<br/>';
            $cardpls=$model->table('card_purchase_logs')->where($map3)->field('purchaseid')->select();
            foreach($cardpls as $key=>$val){
                $where=array('purchaseid'=>$val['purchaseid'],'customid'=>$custom['customid']);
                $model->table('custom_purchase_logs')->where($where)->delete();
                echo $model->getLastSql().';<br/>';

                $map5=array('purchaseid'=>$val['purchaseid']);
                $adutid= $model->table('audit_logs')->where($map5)->max('auditid');
                $map6=array('purchaseid'=>$val['purchaseid'],'auditid'=>$adutid);
                $model->table('audit_logs')->where($map6)->delete();
                echo $model->getLastSql().';<br/>';
            }
            $model->table('card_purchase_logs')->where($map3)->delete();
            echo $model->getLastSql().';<br/>';
        }
    }

    //删除积分
    public function test333(){
        $array=array(
            array('cardno'=>'2336370888801018116'),
        );
        $model=new Model();
        foreach($array as $key=>$val){
            $model->startTrans();
            $cardno=$val['cardno'];
            $map=array('cardno'=>$cardno);
            $card=$model->table('cards')->where($map)->find();
            $cardid=$card['customid'];
            $map1=array('cid'=>$cardid);
            $custom=$model->table('customs_c')->where($map1)->field('customid')->find();
            $map5=array('customid'=>$custom['customid']);
            $model->table('customs')->where($map5)->delete();
            echo $model->getLastSql().';<br/>';
            $map11=array('cid'=>$cardid,'customid'=>$custom['customid']);
            $model->table('customs_c')->where($map11)->delete();
            echo $model->getLastSql().';<br/>';
            $map2=array('customid'=>$cardid);
            $model->table('account')->where($map2)->delete();
            echo $model->getLastSql().';<br/>';
            $model->table('cards')->where($map)->delete();
            echo $model->getLastSql().';<br/>';
            //$model->commit();
            $model->rollback();
        }
    }

    //君邻会判断两张卡的会员
    public function test4444(){
        $map=array('c.panterid'=>'00000447','c.status'=>'Y');
        $cards=M('cards');
        $customsC=M('customs_c');
        $customs=M('customs');
        $custom=$cards->alias('c')->join('customs_c cc on cc.cid=c.customid')
            ->join('customs cu on cu.customid=cc.customid')->where($map)
            ->field('cu.customid,c.customid cid,c.cardno,cu.namechinese')->select();
        foreach($custom as $key=>$val){
            $map1=array('cu.customid'=>$val['customid'],'c.panterid'=>'00000447','c.status'=>'Y');
            $c=$customs->alias('cu')->join('customs_c cc on cc.customid=cu.customid')
                ->join('cards c on c.customid=cc.cid')->where($map1)->count();
            if($c>1){
                echo $val['customid'].'&nbsp;'.$val['cid'].'&nbsp;'.$val['cardno'].'&nbsp;'.$val['namechinese'].'<br/>';
            }
        }
    }

    //一家余额转移
    public function test125(){
        $cardArr=array(
//            array('cardno'=>'6886371800000111199','amount'=>'4819.1'),
//            array('cardno'=>'6886371800000119250','amount'=>'108'),
//            array('cardno'=>'6886371800000116395','amount'=>'246'),
        );
        $userid='0000000000000204';
        $model=new Model();
        foreach($cardArr as $val){
            $model->startTrans();
            $waitAmount=$val['amount'];
            $cardno=$val['cardno'];
            $userstr= substr($userid,12,4);
            //$purchaseid=$this->getnextcode('PurchaseId ',12);//获得PurchaseId 12位编号
            $purchaseid=$this->getFieldNextNumber('purchaseid');
            $purchaseid=$userstr.$purchaseid;
            $currentDate=date('Ymd');
            $checkDate=date('Ymd');

            $where['c.cardno']=$cardno;
            $where['a.type']='00';
            $card=$model->table('cards')->alias('c')->join('account a on a.customid=c.customid')
                ->where($where)->field('c.customid,a.amount,c.panterid')->find();
            $customplSql="insert into custom_purchase_logs values('".$card['customid']."','".$purchaseid."','".$currentDate."','现金','";
            $customplSql.=$userid."','".$waitAmount."',NULL,'".$waitAmount."',0,'".$waitAmount."','".$waitAmount;
            $customplSql.="',1,'','','1','".$card['panterid']."','".$userid."',NULL,'1',";
            $customplSql.="'0',NULL,'00000000','".date('H:i:s')."','".$checkDate."','".date('H:i:s',time()+300)."',NULL)";

            //写入审核单
            //$auditid=$this->getnextcode('audit_logs',16);
            $auditid=$this->getFieldNextNumber('auditid');
            $auditlogsSql="insert into audit_logs values ('".$auditid."','".$purchaseid."','审核通过',";
            $auditlogsSql.="'一家充值审核通过','".date('Ymd')."','".$userid ."','".date('H:i:s',time()+300)."')";

            $customplIf=$model->execute($customplSql);
            $auditlogsIf=$model->execute($auditlogsSql);

            //$cardpurchaseid=$this->getnextcode('card_purchase_logs',18);
            $cardpurchaseid=$this->getFieldNextNumber('cardpurchaseid');
            //写入充值单
            $cardplSql="INSERT INTO card_purchase_logs VALUES('{$cardpurchaseid}','{$purchaseid}',";
            $cardplSql.="'{$cardno}','{$waitAmount}','0','".$currentDate."','".date('H:i:s',time()+300)."','1','',";
            $cardplSql.="'{$userid}','{$card['panterid']}','','00000000')";
            $cardplIf=$model->execute($cardplSql);

            $balanceSql="UPDATE account SET amount=nvl(amount,0)+".$waitAmount." where customid='".$card['customid']."' and type='00'";
            $balanceIf=$this->model->execute($balanceSql);
            if($customplIf==true&&$auditlogsIf==true&&$cardplIf==true&&$balanceIf==true){
                $model->commit();
            }else{
                $model->rollback();
            }
        }
    }

    public function test000(){
        $where=array('linktel'=>array('EXP','IS NOT NULL'),'customlevel'=>'建业线上会员');
        $list=M('customs')->field('linktel')->where($where)->group('linktel')->select();
        foreach($list as $key=>$val){
            echo $val['linktel'].'<br/>';
        }
    }
    public function test0909(){
        $nameArr=array(
        //array('namechinese'=>'王伟','linktel'=>'18620291611','personid'=>'410821198302080017')
        );
        $model=new Model();
        foreach($nameArr as $val){
            //$customid=$this->getnextcode('customs',8);
            $customid=$this->getFieldNextNumber('customid');
            $namechinese=$val['namechinese'];
            $linktel=$val['linktel'];
            $personid=$val['personid'];
            $sql="insert into customs(customid,namechinese,placeddate,customlevel,linktel,personid) ";
            $sql.="values('{$customid}','{$namechinese}','".date('Ymd')."','建业线上会员1','{$linktel}','{$personid}')";
            $model->execute($sql);
        }
        exit;
        $array=array();
        $sql='';
        foreach($array as $key=>$val){
            $tradeid=trim($val['tradeid']);
            $sql.="UPDATE TRADE_WASTEBOOKS SET PLACEDDATE='20160802' WHERE tradeid='{$tradeid}';<br/>";
        }
        echo $sql;
    }

    //酒店礼品卡导入
    public function test111(){
        $des=new  Des('238ab9c87d4569a59b0c8d7e9A0D9C8B238ab9c87d4569a5');
        $arr=array(
            //array("cardno"=>"2081180140100076011","pwd"=>"471842","namechinese"=>"艾美礼品卡401"),
        );
        $model=new Model();
        foreach($arr as $key=>$val){
            $model->startTrans();
            $customid=$this->getnextcode('customs',8);
            $customid=$this->getFieldNextNumber('customid');
            $customSql="insert into customs(customid,namechinese,placeddate) ";
            $customSql.="values('{$customid}','{$val['namechinese']}','".date('Ymd')."')";
            $customIf=$model->execute($customSql);

            $pwd=$des->doEncrypt($val['pwd']);

            $cardSql="INSERT INTO CARDS(CARDNO,CARDKIND,CUSTOMID,CARDPASSWORD,EXDATE,STATUS,CARDBALANCE,PANTERID,BRANDID) VALUES";
            $cardSql.=" ('{$val['cardno']}','2081','{$customid}','{$pwd}','20201231','Y',0,'00000126','2081')";
            $cardIf=$model->execute($cardSql);

            $customcSql="INSERT INTO customs_c(customid,cid) VALUES('".$customid."','".$customid ."')";
            $customsCIf=$model->execute($customcSql);

            //$acid = $this->getnextcode('account',8);
            $acid = $this->getFieldNextNumber('accountid');
            $balanceSql="INSERT INTO account(accountid,customid,amount,type,quanid) VALUES('";
            $balanceSql.=$acid."','".$customid."','0','00',NULL)";
            $balanceIf=$model->execute($balanceSql);

            //$acid = $this->getnextcode('account',8);
            $acid = $this->getFieldNextNumber('accountid');
            $pointSql="INSERT INTO account(accountid,customid,amount,type,quanid) VALUES('";
            $pointSql.=$acid."','".$customid."','0','01',NULL)";
            $pointIf=$model->execute($pointSql);
            if($customIf==true&&$cardIf==true&&$customsCIf==true&&$balanceIf==true&&$pointIf==true){
                $model->commit();
            }else{
                $model->rollback();
            }
        }
    }

    //房掌柜已充值订单撤回
    public function test0000(){
        //echo '123';exit;
        set_time_limit(0);
        $array=array();
        $model=new Model();
        $sql="";
        foreach($array as $key=>$val){
            $map=array('cpl1.cardno'=>$val['cardno'],'cpl.tradeflag'=>0);
            $list=$model->table('custom_purchase_logs')->alias('cpl')
                ->join('card_purchase_logs cpl1 on cpl1.purchaseid=cpl.purchaseid')
                ->where($map)->field('cpl.purchaseid,cpl1.card_purchaseid')
                ->find();
            $sql.="update custom_purchase_logs set panterid='{$val['panterid']}' where purchaseid='{$list['purchaseid']}';commit;<br/>";
            $sql.="update card_purchase_logs set panterid='{$val['panterid']}' where card_purchaseid='{$list['card_purchaseid']}';commit;<br/>";
        }
        echo $sql;exit;
        $array=array();
        $cards=M('cards');
        $model=new Model();
        foreach($array as $key=>$val){
            $cardno=$val['cardno'];
            $tradeid=$val['tradeid'];
            $amount=$val['amount'];
            $map=array('cardno'=>$cardno);
            $card=$cards->where($map)->field('customid')->find();
            $accountSql="update account set amount=amount+{$amount} where customid='{$card['customid']}' and type='00'";
            $fangzcSql="update fangzg_c set status=0,consumedamount=consumedamount-{$amount} where cardno='{$cardno}' and tradeid='{$tradeid}'";
            $tradeSql="delete from trade_wastebooks where cardno='{$cardno}' and placeddate='20300101'";
            $fangzgSql="update fangzg set status=1,consumedmoney=consumedmoney-{$amount} where tradeid='{$tradeid}'";
            $model->startTrans();
            $accountIf=$model->execute($accountSql);
            $fangzcIf=$model->execute($fangzcSql);
            $tradeIf=$model->execute($tradeSql);
            $fangzgIf=$model->execute($fangzgSql);
//            echo $accountSql.'<br/>';
//            echo $fangzcSql.'<br/>';
//            echo $tradeSql.'<br/>';
//            echo $fangzgSql;exit;
            if($accountIf==true&&$fangzcIf&&$tradeIf==true&&$fangzgIf==true){
                $model->commit();
            }else{
                $model->rollback();
            }
        }
    }
    //艾美酒店卡密码初始化
    public function resetcode(){
        $this->des=new  Des('238ab9c87d4569a59b0c8d7e9A0D9C8B238ab9c87d4569a5');
        $array=array('6882371088800016888','6882371088800016889','6882371088800016890','6882371088800016891','6882371088800016892','6882371088800016893','688237108880001689',            '6882371088800016895','6882371088800016896','6882371088800016897','6882371088800016898','6882371088800016899','6882371088800016900','6882371088800016901',                  '6882371088800016902','6882371088800016903','6882371088800016904','6882371088800016905','6882371088800016906','6882371088800016907','6882371088800016908',                   '68823710888000','6909','6882371088800016910','6882371088800016911','6882371088800016912','6882371088800016913','6882371088800016914','6882371088800016915',                 '6882371088800016916','6882371088800016917','6882371088800016919','6882371088800016920','6882371088800016921','6882371088800016922','6882371088800016923',                   '6882371088800016924','6882371088800016925','6882371088800016926','6882371088800016927','6882371088800016928','6882371088800016929','6882371088800016930',                   '6882371088800016931','6882371088800016932','6882371088800016933','6882371088800016934','6882371088800016935','6882371088800016936','6882371088800016918');
        foreach($array as $k=>$v){
            $map=array('cardno'=>$v,'status'=>'N','makedate'=>'20170927');
            $cardif = M('cards')->where($map)->find();
            if(true==$cardif){
                $cardpass = '888888';
                $cardpass = $this->des->doEncrypt($cardpass);
                $bool = M('cards')->where($map)->save(array('cardpassword'=>$cardpass));
                if(true==$bool){
                    $this->success('卡密码重置成功！');
                }else
                    $this->error('请联系管理员！');
            }else{
                $this->error('请检查卡号 或卡必须是正常卡！');
            }
        }
    }

}




